# NIO





## 说一说NIO是什么



NIO  newIO 或称为同步非阻塞IO  ，是用通道来双向传输数据，缓存区来存储数据，用选择器来注册通道，监控通道的状态来实现非阻塞IO操作的IO    



## 说一说NIO的底层原理（程序和操作系统层面）



NIO的本地IO操作是用户地址空间和操作系统内核地址空间数据的相互传输而进行的，并通过通道进行IO控制，如果NIO使用非直接缓存进行数据存储，数据的传输就是通过用户地址空间和内核地址空间的复制操作来传输的，如果使用的是直接缓存，就会在物理内存中开辟一个内存映射空间，来代替复制操作提高效率，这也是netty使用的方式。



## NIO 同步在哪？非阻塞在哪？



NIO的同步在于线程进行IO操作是同步的，就比如用户地址空间和内核地址空间的数据传输流程是同步的。



NIO的非阻塞是因为有选择器来注册和监控通道，在某一个通道数据准备好的情况下才开一个线程对通道中的数据进行IO操作，防止以为通道中没有数据而造成线程阻塞浪费资源的现象。



## 说一说epoll的原理



epoll是linux操作系统的内核函数，它内部主要调用了三个函数，先通过epoll_create函数 建立一个epoll对象，并在文件系统中为这个对象分配资源。  然后调用epoll_ctl函数向epoll对象中添加连接的套接字Socket，最后调用epoll_wait函数手机发送事件的连接（比如某个Socket有数据传来）。

事件的结构体叫epitem 

每个epoll对象都有一个eventpoll 结构体

其结构：

红黑树存储需要监控的事件（Socket）

双链表存储需要返回的事件



在epoll中的事件会和网卡建立回调关系，当事件发送时，就调用回调函数把事件添加到结构体的双链表中。

在调用epoll_wait函数的时候就会去检查这个双链表中有没有epitem对象，也就是检查有没有事件，有就把事件复制到用户态（就是相当于把数据传到用户态）